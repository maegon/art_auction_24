<!DOCTYPE html>
<html layout:decorate="~{/layout/layout}">

<head>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
          const birthDateElement = document.getElementById('birthDate');
          const telElement = document.getElementById('tel');
          const thumbnailPreview = document.getElementById('thumbnailPreview');
          const thumbnailInput = document.getElementById('thumbnail');
          // birthDate가 "yyyy.MM.dd" 형식으로 입력된 경우, "yyyyMMdd" 형식으로 변환
          if (birthDateElement) {
            let birthDate = birthDateElement.value.trim();
            if (birthDate.includes('.')) {
              birthDateElement.value = birthDate.replace(/\./g, '');
            }
          }
          // tel이 "010-1234-5678" 형식으로 입력된 경우, "01012345678" 형식으로 변환
          if (telElement) {
            let tel = telElement.value.trim();
            if (tel.includes('-')) {
              telElement.value = tel.replace(/-/g, '');
            }
          }
          const engNameInput = document.getElementById('engName');
          const korNameInput = document.getElementById('korName');
          const engNameDisplay = document.getElementById('engNameDisplay');
          const korNameDisplay = document.getElementById('korNameDisplay');

          function updateName() {
            engNameDisplay.textContent = engNameInput.value;
            korNameDisplay.textContent = korNameInput.value;
          }
          engNameInput.addEventListener('input', updateName);
          korNameInput.addEventListener('input', updateName);

          // artistAdds 값 처리 - 각 값을 콤마로 구분하여 별도의 필드로 추가
          const artistAddsValues = /*[[${artistForm.artistAdds}]]*/ [];
          artistAddsValues.forEach(value => {
              const splitValues = value.split(',').map(v => v.trim());
              splitValues.forEach(splitValue => {
                  addSimpleInputField('artistAddsContainer', 'artistAdds', splitValue);
              });
          });

          // Load existing data
          const contentAddsValues = /*[[${artistForm.contentAdds}]]*/ [];
          contentAddsValues.forEach(value => {
            addSimpleInputField('contentAddsContainer_3', 'contentAdds', value);
          });
          const titleAddsValues = /*[[${artistForm.titleAdds}]]*/ [];
          titleAddsValues.forEach(value => {
            addSimpleInputField('titleAddsContainer', 'titleAdds', value);
          });
          const titleContentAddsValues = /*[[${artistForm.titleContentAdds}]]*/ [];
          const yearContentAddsValues = /*[[${artistForm.yearContentAdds}]]*/ [];
          const widthContentAddsValues = /*[[${artistForm.widthContentAdds}]]*/ [];
          const heightContentAddsValues = /*[[${artistForm.heightContentAdds}]]*/ [];
          const unitContentAddsValues = /*[[${artistForm.unitContentAdds}]]*/ [];
          const techniqueContentAddsValues = /*[[${artistForm.techniqueContentAdds}]]*/ [];
          // Call the function to add input fields with existing values
          addInputFieldsWithValues('contentAddsContainer_2', titleContentAddsValues, yearContentAddsValues, widthContentAddsValues, heightContentAddsValues, unitContentAddsValues, techniqueContentAddsValues);
          // Initial image preview setup
          if (thumbnailPreview.src) {
            thumbnailPreview.style.display = 'block';
          } else {
            thumbnailPreview.style.display = 'none';
          }
          const selectElement = document.getElementById('mailType');
          const inputElement = document.getElementById('mailTypeInput');
          const selectElementDiv = document.getElementById('mailTypeDiv');

          function setupMailTypeField() {
            if (selectElement.value === 'self') {
              selectElementDiv.style.display = 'none';
              inputElement.style.display = 'inline-block';
              inputElement.name = "mailType";
            } else if (selectElement.value !== '') {
              selectElementDiv.style.display = 'block';
              inputElement.style.display = 'none';
              selectElement.name = "mailType";
            } else {
              selectElementDiv.style.display = 'block';
              inputElement.style.display = 'none';
              inputElement.name = "";
            }
          }
          setupMailTypeField();
          selectElement.addEventListener('change', function() {
            if (this.value === 'self') {
              selectElementDiv.style.display = 'none';
              inputElement.style.display = 'inline-block';
              inputElement.name = "mailType";
              inputElement.focus();
            } else {
              inputElement.style.display = 'none';
              inputElement.value = ''; // 자동 입력 필드를 비우고 숨김
              inputElement.name = "";
              selectElement.name = "mailType";
              selectElementDiv.style.display = 'block';
            }
          });
          inputElement.addEventListener('blur', function() {
            if (this.value === 'self') {
              selectElementDiv.style.display = 'none';
              inputElement.style.display = 'inline-block';
              inputElement.name = "mailType";
            } else {
              inputElement.style.display = 'none';
              inputElement.value = ''; // 자동 입력 필드를 비우고 숨김
              inputElement.name = "";
              selectElement.name = "mailType";
              selectElementDiv.style.display = 'block';
            }
          });
        });

        function addInputField(containerId, inputName, initialButton = null) {
          const container = document.getElementById(containerId);
          if (!container) {
            console.error('Specified container not found');
            return;
          }
          // Remove the initial '+' button if it exists
          if (initialButton) {
            initialButton.remove();
          }
          // Remove '+' button from the last input group if it exists
          const existingPlusButton = container.querySelector('.plusBnt');
          if (existingPlusButton) {
            existingPlusButton.parentElement.removeChild(existingPlusButton);
          }
          const inputGroup = document.createElement('div');
          inputGroup.className = 'input-group';
          const input = document.createElement('input');
          input.type = 'text';
          input.name = inputName;
          input.className = 'form-control_text_adds';
          input.placeholder = '추가 입력';
          // Create remove button
          const removeButton = document.createElement('button');
          removeButton.type = 'button';
          removeButton.className = 'remove-button';
          removeButton.textContent = '-';
          removeButton.onclick = function() {
            container.removeChild(inputGroup);
            handleFieldRemoval(containerId, inputName);
          };
          // Append input and remove button to input group
          inputGroup.appendChild(input);
          inputGroup.appendChild(removeButton);
          // Append input group to the container
          container.appendChild(inputGroup);
          // Create and append the '+' button to the last input group
          const plusButton = document.createElement('button');
          plusButton.type = 'button';
          plusButton.className = 'plusBnt';
          plusButton.textContent = '+';
          plusButton.onclick = function() {
            addInputField(containerId, inputName);
          };
          inputGroup.appendChild(plusButton);
        }

        function handleFieldRemoval(containerId, inputName) {
          const container = document.getElementById(containerId);
          if (container.children.length === 0) {
            // If no more fields, show the initial + button
            const initialButton = document.createElement('button');
            initialButton.type = 'button';
            initialButton.className = 'plusBnt';
            initialButton.textContent = '+';
            initialButton.onclick = function() {
              addInputField(containerId, inputName, initialButton);
            };
            container.parentElement.appendChild(initialButton);
          } else {
            // Ensure only the last field has a + button
            const lastInputGroup = container.lastElementChild;
            if (!lastInputGroup.querySelector('.plusBnt')) {
              const plusButton = document.createElement('button');
              plusButton.type = 'button';
              plusButton.className = 'plusBnt';
              plusButton.textContent = '+';
              plusButton.onclick = function() {
                addInputField(containerId, inputName);
              };
              lastInputGroup.appendChild(plusButton);
            }
          }
        }

        function addInputFields(initialButton = null) {
          const container = document.getElementById('contentAddsContainer_2');
          // Remove the initial '+' button if it exists
          if (initialButton) {
            initialButton.remove();
          }
          // Remove '+' button from the last input group if it exists
          const existingPlusButton = container.querySelector('.plusBnt');
          if (existingPlusButton) {
            existingPlusButton.parentElement.removeChild(existingPlusButton);
          }
          const inputGroup = document.createElement('div');
          inputGroup.className = 'input-group-mw';
          const titleInput = document.createElement('input');
          titleInput.type = 'text';
          titleInput.name = 'titleContentAdds';
          titleInput.className = 'MWContentAdds';
          titleInput.placeholder = '제목';
          inputGroup.appendChild(titleInput);
          const yearInput = document.createElement('input');
          yearInput.type = 'text';
          yearInput.name = 'yearContentAdds';
          yearInput.className = 'MWContentAdds';
          yearInput.placeholder = '제작년도';
          inputGroup.appendChild(yearInput);
          const widthInput = document.createElement('input');
          widthInput.type = 'text';
          widthInput.name = 'widthContentAdds';
          widthInput.className = 'MWContentAdds';
          widthInput.placeholder = '가로 길이';
          inputGroup.appendChild(widthInput);
          const spanX = document.createElement('span');
          spanX.textContent = 'X';
          spanX.className = 'SPAN-X';
          inputGroup.appendChild(spanX);
          const heightInput = document.createElement('input');
          heightInput.type = 'text';
          heightInput.name = 'heightContentAdds';
          heightInput.className = 'MWContentAdds';
          heightInput.placeholder = '세로 길이';
          inputGroup.appendChild(heightInput);
          const unitInput = document.createElement('input');
          unitInput.type = 'text';
          unitInput.name = 'unitContentAdds';
          unitInput.className = 'MWContentAdds';
          unitInput.placeholder = '길이 단위';
          inputGroup.appendChild(unitInput);
          const techniqueInput = document.createElement('input');
          techniqueInput.type = 'text';
          techniqueInput.name = 'techniqueContentAdds';
          techniqueInput.className = 'MWContentAdds';
          techniqueInput.placeholder = '제작 기법';
          inputGroup.appendChild(techniqueInput);
          // Create remove button
          const removeButton = document.createElement('button');
          removeButton.type = 'button';
          removeButton.className = 'remove-button';
          removeButton.textContent = '-';
          removeButton.onclick = function() {
            container.removeChild(inputGroup);
            handleFieldRemoval();
          };
          inputGroup.appendChild(removeButton);
          // Create and append the '+' button to the last input group
          const plusButton = document.createElement('button');
          plusButton.type = 'button';
          plusButton.className = 'plusBnt';
          plusButton.textContent = '+';
          plusButton.onclick = function() {
            addInputFields();
          };
          inputGroup.appendChild(plusButton);
          container.appendChild(inputGroup);
        }

        function handleFieldRemoval() {
          const container = document.getElementById('contentAddsContainer_2');
          if (container.children.length === 0) {
            // If no more fields, show the initial + button
            const initialButton = document.createElement('button');
            initialButton.type = 'button';
            initialButton.className = 'plusBnt';
            initialButton.textContent = '+';
            initialButton.onclick = function() {
              addInputFields(initialButton);
            };
            container.parentElement.appendChild(initialButton);
          } else {
            // Ensure only the last field has a + button
            const lastInputGroup = container.lastElementChild;
            if (!lastInputGroup.querySelector('.plusBnt')) {
              const plusButton = document.createElement('button');
              plusButton.type = 'button';
              plusButton.className = 'plusBnt';
              plusButton.textContent = '+';
              plusButton.onclick = function() {
                addInputFields();
              };
              lastInputGroup.appendChild(plusButton);
            }
          }
        }

        function triggerFileInput() {
          document.getElementById('thumbnail').click();
        }

        function previewThumbnail(input) {
          if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
              const preview = document.getElementById('thumbnailPreview');
              preview.src = e.target.result;
              preview.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
          }
        }
        let fieldGroupCount = 0; // 초기 필드 그룹 수
        function addFieldGroup(initialButton = null) {
          const formContainer = document.getElementById('formContainer');
          // 초기 '+' 버튼을 누르면 사라지도록 설정
          if (initialButton) {
            initialButton.remove();
          }
          const newFieldGroup = document.createElement('div');
          newFieldGroup.classList.add('field-group');
          newFieldGroup.innerHTML = `
            <div class="titleAdd input-group">
                <input type="text" name="titleAdds" class="form-control_ti" placeholder="추가 제목" />
                <button type="button" class="remove-button" onclick="removeFieldGroup(this)">-</button>
            </div>
            <div class="contentAdd">
                <div class="input-group">
                    <input type="text" name="contentAdds" class="form-control_text" placeholder="추가 내용" />
                    <button type="button" class="remove-button" onclick="removeContentField(this)">-</button>
                    <button type="button" class="plusBnt" onclick="addContentField(this)">+</button>
                </div>
            </div>
        `;
          formContainer.appendChild(newFieldGroup);
          fieldGroupCount++;
          if (fieldGroupCount >= 2) {
            document.getElementById('addFieldGroupButton').style.display = 'none';
          }
        }

        function addContentField(button) {
          const contentContainer = button.closest('.contentAdd');
          const newContentField = document.createElement('div');
          newContentField.className = 'input-group';
          newContentField.innerHTML = `
            <input type="text" name="contentAdds" class="form-control_text" placeholder="추가 내용" />
            <button type="button" class="remove-button" onclick="removeContentField(this)">-</button>
        `;
          const existingPlusButton = contentContainer.querySelector('.plusBnt');
          if (existingPlusButton) {
            existingPlusButton.remove();
          }
          contentContainer.appendChild(newContentField);
          addPlusButtonToLastContentAdd(contentContainer.closest('.field-group'));
        }

        function removeFieldGroup(button) {
          const fieldGroup = button.closest('.field-group');
          fieldGroup.parentNode.removeChild(fieldGroup);
          fieldGroupCount--;
          const formContainer = document.getElementById('formContainer');
          if (fieldGroupCount < 2) {
            document.getElementById('addFieldGroupButton').style.display = 'inline-block';
          }
          addPlusButtonToLastContentAdd(formContainer.lastElementChild);
        }

        function removeContentField(button) {
          const contentField = button.parentNode;
          const contentContainer = contentField.parentNode;
          contentField.parentNode.removeChild(contentField);
          addPlusButtonToLastContentAdd(contentContainer.closest('.field-group'));
        }

        function addPlusButtonToLastContentAdd(fieldGroup) {
          if (!fieldGroup) return;
          const contentAdds = fieldGroup.querySelectorAll('.contentAdd .input-group, .contentAdd');
          if (contentAdds.length > 0) {
            const lastContentAdd = contentAdds[contentAdds.length - 1];
            const plusButton = document.createElement('button');
            plusButton.type = 'button';
            plusButton.className = 'plusBnt';
            plusButton.textContent = '+';
            plusButton.onclick = function() {
              addContentField(plusButton);
            };
            lastContentAdd.appendChild(plusButton);
          }
        }

        function removeAllPlusButtons() {
          const plusButtons = document.querySelectorAll('.plusBnt');
          plusButtons.forEach(button => button.remove());
        }
    </script>

</head>

<body>
<div layout:fragment="content">
    <form th:action="@{/artist/modify/{id}(id=${artist.id})}" th:object="${artistForm}" method="post" enctype="multipart/form-data">
        <div class="artistProfileContainer">
            <div class="basicArtistProfile">
                <div class="artistImgModify">
                    <!-- Image path updated -->
                    <img id="thumbnailPreview" th:src="@{|/file/${artist.thumbnailImg}|}" class="artist-img-Modify" alt="미리보기" onclick="triggerFileInput()">
                    <input type="file" id="thumbnail" th:field="*{thumbnail}" class="artist-img-Modify" onchange="previewThumbnail(this)" style="display: none;">
                </div>
                <div class="engName">
                    <input type="text" id="engName" class="form-control_text" th:field="*{engName}">
                    <div th:if="${#fields.hasErrors('engName')}" th:errors="*{engName}">Incorrect name</div>
                </div>
                <div class="information">
                    <div class="korName">
                        <input type="text" id="korName" class="form-control_text" th:field="*{korName}">
                        <div th:if="${#fields.hasErrors('korName')}" th:errors="*{korName}">Incorrect name</div>
                    </div>
                    <div class="line">
                        <div class="lineInformation">
                            <div class="name-group">
                                <span id="korNameDisplay" th:text="${artist.korName}"></span>
                                (<span id="engNameDisplay" th:text="${artist.engName}"></span>)
                            </div>
                            <div class="birthDateNumModify">
                                <input type="text" id="birthDate" class="form-control_text" th:field="*{birthDate}">
                                <div th:if="${#fields.hasErrors('birthDate')}" th:errors="*{birthDate}">Incorrect birth date</div>
                            </div>
                            <div class="artistAdd">
                                <!-- 기존 데이터가 있으면 input 필드에 값을 넣고, 없으면 빈 필드를 렌더링하지 않음 -->
                                <div th:if="${artistForm.artistAdds != null}">
                                    <input type="text" id="artistAdds" class="form-control_text_add" placeholder="추가 내용" th:field="*{artistAdds}">
                                </div>
                                <!-- 입력 필드와 버튼이 추가될 위치 -->
                                <div id="artistAddsContainer"></div>
                                <!-- 초기 '+' 버튼 -->
                                <button type="button" class="plusBnt" onclick="addInputField('artistAddsContainer', 'artistAdds', this)">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="textArtistProfile_1">
                <div class="textAdd_1">
                    <div class="textTileForm">
                        <span class="title">INTRODUCE</span>
                        <div class="contentAdd">
                            <textarea id="introduce" class="form-control" th:field="*{introduce}"></textarea>
                            <div th:if="${#fields.hasErrors('introduce')}" th:errors="*{introduce}">Incorrect content</div>
                        </div>
                    </div>
                    <div class="textTileForm">
                        <span class="title">MAJOR WORK</span>
                        <div class="contentAddContainer" id="contentAddsContainer_2">
                            <div class="input-group-mw">
                                <div th:if="${artistForm.titleContentAdds != null}">
                                    <input type="text" id="titleContentAdds" class="MWContentAdds" placeholder="제목" th:field="*{titleContentAdds}">
                                </div>
                                <div th:if="${artistForm.yearContentAdds != null}">
                                    <input type="text" id="yearContentAdds" class="MWContentAdds" placeholder="제작년도" th:field="*{yearContentAdds}">
                                </div>
                                <div th:if="${artistForm.widthContentAdds != null}">
                                    <input type="text" id="widthContentAdds" class="MWContentAdds" placeholder="가로 길이" th:field="*{widthContentAdds}">
                                </div>
                                <span class="SPAN">X</span>
                                <div th:if="${artistForm.heightContentAdds != null}">
                                    <input type="text" id="heightContentAdds" class="MWContentAdds" placeholder="세로 길이" th:field="*{heightContentAdds}">
                                </div>
                                <div th:if="${artistForm.unitContentAdds != null}">
                                    <input type="text" id="unitContentAdds" class="MWContentAdds" placeholder="길이 단위" th:field="*{unitContentAdds}">
                                </div>
                                <div th:if="${artistForm.techniqueContentAdds != null}">
                                    <input type="text" id="techniqueContentAdds" class="MWContentAdds" placeholder="제작 기법" th:field="*{techniqueContentAdds}">
                                </div>
                            </div>
                            <!-- 여기서 기존 contentAdds 값들을 스크립트로 추가 -->
                        </div>
                        <!-- 초기 + 버튼 -->
                        <button type="button" class="plusBnt" onclick="addInputFields(this)">+</button>
                    </div>
                    <div class="textTileForm" id="formContainer">
                        <!--                        <div class="titleAdd" th:if="${artistForm.titleAdds != null}">-->
                        <!--                            <input type="text" id="titleAdds" class="form-control_text" placeholder="추가 제목" th:field="*{titleAdds}">-->
                        <!--                        </div>-->
                        <!--                        <div class="contentAdd" th:if="${artistForm.contentAdds != null}">-->
                        <!--                            <input type="text" id="contentAdds" class="form-control_text" placeholder="추가 내용" th:field="*{contentAdds}">-->
                        <!--                        </div>-->
                        <!-- 필드 그룹이 추가되는 컨테이너 -->
                    </div>
                    <button type="button" id="addFieldGroupButton" class="plusBnt" onclick="addFieldGroup()">+</button>
                    <div class="button">
                        <input type="submit" value="저장하기">
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
</body>
</html>